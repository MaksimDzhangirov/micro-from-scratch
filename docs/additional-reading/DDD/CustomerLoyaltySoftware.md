# Программное обеспечение лояльности пользователя 

4 сентября 2007

![Martin Fowler](../microservice-guide/images/microservices/mf.jpg)

[Мартин Фаулер](https://martinfowler.com/)

[ПРЕДМЕТНО-ОРИЕНТИРОВАННОЕ ПРОЕКТИРОВАНИЕ](https://martinfowler.com/tags/domain%20driven%20design.html)

На прошлой неделе я был в офисе в Калгари и хорошо поболтал с Джоном Кордибаком, 
одним из наших самых надежных технических руководителей. Он работал и копался в 
ряде программных систем лояльности в поездках (часто летающих/привлечение старых клиентов и т. д.), и 
мы говорили о природе таких вещей и о том, как думать о них более плодотворно.

Ядром системы лояльности является система учета баллов (или миль). Это должно 
позволить клиентам видеть свои баллы, а также компании управлять неиспользованными 
баллами. Хотя кажется, что большинство людей так их не воспринимают, по сути 
это система учета, если просто заменить баллы на доллары. По наблюдениям Джона, 
он постоянно сталкивается с тем, что люди считают сложными проблемами, с 
которыми гораздо легче справиться, если представить их с точки зрения бухгалтера.

Примером этого является ручное внесение изменений. Какой бы хорошей ни была ваша 
автоматическая обработка правил, всегда случаются случаи, когда происходит 
что-то странное, и вам приходится вмешиваться вручную. Результатом для многих 
систем является случайное изменение итоговых сумм, которое подвержено ошибкам 
и тяжело проверить. Однако с точки зрения бухгалтерского учета вы смотрите на 
эти изменения как на корректировки бухгалтерского учета, и [принципы работы с ними](https://martinfowler.com/eaaDev/AccountingNarrative.html) 
хорошо известны.

Заметное различие между программой лояльности и большинством систем бухгалтерского 
учета заключается в том, что программа лояльности больше связана с управлением пассивами, 
чем с управлением активами. Следовательно, больше внимания уделяется таким вещам, 
как управление рисками, а также общим темам, таким как налоги и отчетность о 
доходах.

Многие системы лояльности имеют несколько типов баллов, например, обычные мили 
и элитные квалификационные мили. Это часто приводит к сложностям. Однако, если
вы посмотрите на них с точки зрения бухгалтерского учета, вы можете легко 
отслеживать их как несколько валют.

Интересной особенностью здесь являются потенциальные баллы. Если я бронирую 
рейс на следующий месяц, авиакомпания должна знать, сколько миль я заработаю 
за полет в следующем месяце (потенциальные балы). Эти потенциальные мили влияют 
на их пассивы. Однако только когда я полетел, они превращаются в настоящие мили.
Опять же, бухгалтерское мышление может помочь здесь, мы можем снова использовать 
несколько валют или использовать понятие кредиторской задолженности. Механизмы 
есть и они хорошо понятны, нам просто нужно применить модель к ситуации.

Мы конкретизировали это на практике, где мы также обнаружили, что очень полезно 
использовать [разработку через тестирование](https://martinfowler.com/bliki/TestDrivenDevelopment.html).
Группа людей потратила пару недель, пытаясь определить потенциальные мили с 
помощью запланированного проектирования, но основная проблема была решена за 
пару дней с помощью TDD. Важнейшей частью этого было сосредоточение внимания на 
примерах, чтобы конкретизировать проблему.

Аналогия с бухгалтерским учетом также применима, хотя и в меньшей степени, к 
решению о том, как начислять мили за активность. Любая программа имеет правила, 
которые должны быть очень гибкими и соответствовать постоянным изменениям в 
программе лояльности. Мы можем рассматривать их как срабатывание событий модели предметной 
области, влияющие на сущности бухгалтерского учета через [диспетчеров соглашений](https://martinfowler.com/eaaDev/AgreementDispatcher.html).
Это шаблон, который мы с Джоном использовали много раз, и он хорошо работает с 
такого рода изменением правил. По сути, у нас есть соглашения, которые представляют 
собой общие правила программы для класса участников. Каждое соглашение состоит 
из набора правил, определяемых типом события и диапазоном дат. Когда происходит 
событие домена (пребывание в отеле), мы ищем диспетчера соглашений для клиента 
и используем событие для поиска правильного правила. Затем мы запускаем правило,
чтобы создать сущности бухгалтерского учета, определяющие мили для события. Даты
событий позволяет нам со временем изменять правила, но при этом иметь возможность 
обрабатывать старые события и правильно выполнять автоматическую обработку 
корректировок. (Когда-нибудь я закончу писать эти шаблоны, но, надеюсь, того, 
что есть в сети, достаточно, чтобы предоставить вам некоторые идеи.)

Второй аспект системы лояльности — отслеживание клиентского опыта. Поскольку 
бухгалтерский учет требует, чтобы система регистрировала активность клиента, 
система лояльности действует как естественная база изучения взаимодействия 
клиента с компанией. Во многом это интеллектуальный анализ данных — поиск 
закономерностей в поведении клиентов, которые могут привести к новым продуктам 
и рекламным акциям. Вы также можете использовать эту историю активности, чтобы 
оценить успех рекламных акций — если вы предлагаете бонусные мили за полет по 
маршруту, какой будет реакция?

Как и я, Джон является ярым сторонником использования [ReportingDatabases](https://martinfowler.com/bliki/ReportingDatabase.html), 
и это хорошо подходит для такого рода проблем. Бухгалтерская сторона нуждается 
в совершенно другом наборе структур данных и использует регулярные обновления 
по мере возникновения активности. Весь анализ клиентского опыта доступен только 
для чтения, поэтому вы можете использовать менее нормализованные структуры с 
регулярными, но не обязательно в режиме реального времени, отчётами с точки зрения 
бухгалтерского учёта.

В дальнейшем представляется разумным полностью разделить системы учета и 
взаимодействия с клиентами. Они обе обычно объединяются в единую систему лояльности 
клиентов, потому что отслеживают одни и те же события. Тем не менее, поскольку 
они так сильно различаются внутри, может быть, имеет смысл рассматривать их как 
две отдельные системы, которые используют один и тот же поток событий (система 
бухгалтерского учета, вероятно, также будет генерировать некоторые события для 
системы взаимодействия с клиентами).

Одна из особенностей системы взаимодействия с клиентами — частые изменения в 
системе для поддержки новых видов анализа. Мы предположили, что могли бы 
попробовать подход, который имел бы единый сохраненный журнал событий активности 
клиентов и подключил бы относительно независимых «майнеров», которые будут 
преобразовывать выбранную информацию из журнала в более конкретные структуры 
данных для проведения различных видов анализа. Майнеры могли бы быть относительно 
независимыми друг от друга и, таким образом, их было бы легче создать.

Как видите, наша дискуссия переместилась с анализа опыта Джона на некоторые 
наши совместные размышления о том, как подобная система может быть построена в 
будущем. Нам ясно, что у этой предметной области есть много возможностей для 
изучения новых идей, которые могли бы ввести новый набор абстракций, которые 
привели бы к системам, которые могли бы обеспечить лучшую поддержку этой 
бизнес-деятельности. В наши дни этому уделяется все больше и больше внимания, 
так что это кажется нам плодотворной территорией для работы.