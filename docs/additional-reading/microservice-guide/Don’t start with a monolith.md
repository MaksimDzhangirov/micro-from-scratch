# Не начинайте с монолита

если ваша цель - микросервисная архитектура


[![tilkov](images/Don’t%20start%20with%20a%20monolith/stilkov.jpg)](https://www.innoq.com/blog/st/)
[Стефан Тилков](https://www.innoq.com/blog/st/)

[Микросервисы](https://martinfowler.com/tags/microservices.html)

Стефан Тилков — соучредитель и главный консультант innoQ, технологической 
консалтинговой компании с офисами в Германии и Швейцарии. Он занимается 
проектированием крупномасштабных распределенных систем более двух десятилетий, 
используя различные технологии и инструменты, от C++ и CORBA через J2EE/Java 
EE и веб-сервисы до REST и Ruby on Rails. Он является автором многочисленных 
статей и книги («REST und HTTP», на немецком языке) и часто выступает на 
конференциях по всему миру.

09 июня 2015

За последние несколько месяцев я неоднократно слышал, что единственный способ 
создать успешную архитектуру микросервисов — начать с монолита. Перефразируя 
Саймона Брауна: если вы не можете построить хорошо структурированный монолит, 
почему вы думаете, что можете создать хорошо структурированный набор микросервисов?
Самое последнее — и, как обычно, очень убедительное — изложение этого аргумента 
исходит от Мартина Фаулера на этом самом сайте. Поскольку у меня была возможность 
прокомментировать более ранний черновик его статьи, у меня было время подумать 
об этом. И я так и сделал, особенно потому, что я обычно соглашаюсь с ним, и 
некоторые другие, чьи взгляды я обычно разделяю, похоже, тоже с ним согласны.

Я твердо убежден, что начинать с монолита обычно совершенно неправильно.

Приступая к созданию новой системы, вы должны думать о том, чтобы разделить ее
на части. Я категорически не согласен с идеей, что вы можете отложить это, как 
выразился Сэм Ньюман, опять же тот, с кем я согласен в 95% случаев:

> Я по-прежнему убежден, что гораздо проще разделить существующую "устаревшую" 
> систему, чем сделать это заранее с помощью новой системы. Вам есть над чем 
> работать. У вас есть код, который вы можете изучить, вы можете поговорить с 
> людьми, которые используют и поддерживают систему. Вы также знаете, как будет
> "хорошо" - у вас есть работающая система, которую нужно изменить, чтобы вам 
> было легче узнать, когда вы, возможно, ошиблись или были слишком агрессивны 
> в процессе принятия решений.
> 
> -- [Сэм Ньюман](http://samnewman.io/blog/2015/04/07/microservices-for-greenfield)

В большинстве случаев будет очень сложно, если вообще возможно, разрезать 
существующий монолит таким образом. (Это не означает, что это всегда невозможно, 
но это тема для следующей статьи). Есть некоторая точка соприкосновения в том, 
что я согласен, что вы должны очень хорошо знать предметную область, для 
которого вы строите систему, прежде чем пытаться его разбить, хотя: На мой взгляд, 
идеальный сценарий — это когда вы строите вторую версию существующей системы.

Если вы действительно можете построить хорошо структурированный монолит, вам, 
вероятно, вообще не нужны микросервисы. Что нормально! Я полностью согласен с 
Мартином: вам не следует усложнять систему сложностями при развёртывании, если 
у вас нет для этого очень веской причины.

(Итак, что может быть хорошей причиной? Их много, но для меня самая важная из 
них — обеспечить быструю и независимую доставку отдельных частей в рамках более 
крупной системы. Основное преимущество микросервисов, на мой взгляд, 
заключается в возможности параллельной разработки за счет создания
труднопреодолимой границы между различными частями вашей системы. Тем самым становится 
труднее — или, по крайней мере, сложнее — совершить неправильное действие: 
а именно, соединить части, которые не должны быть соединены, и нарушить связанность тех, 
которые должны быть соединены. Теоретически вам не нужны микросервисы для этого, 
если вы просто дисциплинированы, чтобы следовать четким правилам и устанавливать 
четкие границы в вашем монолитном приложении; на практике я обнаружил, что
такое встречается очень редко).

![monolith-microservice](images/Don’t%20start%20with%20a%20monolith/monolith-theory-practice.svg)
У вас может возникнуть соблазн предположить, что в вашем монолите спрятано 
несколько хорошо разделенных микросервисов, которые только и ждут, чтобы их 
разделили. В действительности, однако, чрезвычайно трудно избежать создания 
множества связей, запланированных и незапланированных. На самом деле весь смысл 
подхода микросервисов в том, чтобы затруднить создание чего-то подобного.

Но если вы начнете с монолита, части станут сильно связанными друг с 
другом. Это и есть определение монолита. Части будут основываться на функционале 
платформы, которую они все используют. Они будут взаимодействовать на основе 
общих абстракций, поскольку все они используют одни и те же библиотеки. Они 
будут взаимодействовать, используя средства, доступные только тогда, когда 
они размещены в одном и том же процессе. И это только технические аспекты!
Хуже того, части будут (почти) свободно совместно использовать объекты 
предметной области, полагаться на одну и ту же общую модель хранения, предполагать, 
что транзакции базы данных легко доступны, так что нет необходимости в 
компенсации... Даже сам факт того, что легко реорганизовать вещи и перемещать 
их — всё удобство просмотра через ваше IDE одного проекта — вот что чрезвычайно 
затрудняет повторное разделение. Чрезвычайно сложно разбить существующий 
монолит на отдельные части.

Я твердо убежден — и опыт ряда наших недавних проектов подтверждает это — что, 
когда вы начинаете, вы должны думать о подсистемах, которые вы создаете, и 
строить их как можно более независимо друг от друга. Конечно, вам следует 
делать это только в том случае, если вы считаете, что ваша система достаточно 
велика, чтобы гарантировать это. Если только вы и один из ваших коллег что-то 
создаете в течение нескольких недель, вполне возможно, что вы этого не 
сделаете.

Но начинать с подхода, при котором вы делите свою систему на более мелкие части 
и рассматриваете каждую из них как четко обособленную индивидуальную систему со 
своим собственным циклом разработки, развертывания и поставки, а также 
(возможно) с собственной внутренней архитектурой, очень мощная концепция, 
которая может помочь вам создать систему в первую очередь.

Так есть ли реальный опыт, подтверждающий это? Да, есть несколько систем, с 
которыми мы недавно работали, которые показали, что эта концепция работает — 
при условии, что вы согласны с тем фактом, что то, о чем я говорю, скорее 
всего, больше, чем ваш типичный микросервис. Самый известный из них — Otto.de, 
о котором [я говорил вместе с их техническим руководителем](http://www.infoq.com/presentations/modular-ecommerce-website) (и о котором вы можете 
прочитать в [этой замечательной статье одного из их ведущих архитекторов](http://dev.otto.de/2015/09/30/on-monoliths-and-microservices/)). Но есть 
и немало других, и я по-прежнему убежден, что начинать строить систему с 
использованием этого подхода — хорошая идея, если вы очень-очень хорошо знаете 
предметную область, для которой создаёте.

Но, на мой взгляд, из этого обсуждения можно извлечь еще один урок — и он 
более общий: остерегайтесь архитектурных решений, которые слишком просты и 
слишком очевидны. Этот - начните с разделения вашей предметной области на 
отдельные независимые части - не исключение. Иногда монолит предпочтительнее, 
иногда нет. Если вы решите создавать что-то с использованием подхода микросервисов, 
вы должны знать, что, хотя будет намного проще принимать локализованные 
решения в каждой отдельной части, будет гораздо сложнее изменить те самые 
границы, которые позволяют это сделать. Рефакторинг чего-то малого становится 
проще, рефакторинг чего-то большого становится намного сложнее.

Как это всегда бывает при обсуждении архитектуры, невозможно обойти тот факт, 
что вам нужно принимать это решение самостоятельно, в каждом отдельном 
случае.

***

## Благодарности

Я благодарен Мартину Фаулеру за комментарии к предыдущей версии этой статьи, а 
также за продолжение обсуждения этой темы в последние несколько недель. Конечно, 
я также более чем счастлив, что он разрешил мне опубликовать её на этом сайте. 
Мои коллеги Даниэль Любке, Оливер Вольф, Алекс Хойзинфельд, Тилль Шульте-Кёрне, 
Андреас Крюгер и Эберхард Вольф также дали ценные отзывы. Особая благодарность 
Роману Штранхёнеру за создание графики.

## Дальнейшее чтение

* [Блог Стефана Тилкова](https://www.innoq.com/blog/st/)
* Видео, в котором Стефан рассказывает о том, [как спроектировать эффективную 
  микросервисную архитектуру](https://www.youtube.com/watch?v=HYiLzji7MuY).
* Статья Стефана в блоге 2013 года о [монолитах и важности их раннего разделения 
  на сервисы](https://www.innoq.com/blog/st/2013/10/on-monoliths/).
* Статья Романа Штранхёнера с кратким [обзором структурирования приложения как 
  микросервиса](https://www.innoq.com/en/links/self-contained-systems-infodeck/) (используя название автономные системы, Роман является коллегой 
  Стефана в innoQ).